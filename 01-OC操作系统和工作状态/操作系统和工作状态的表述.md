## 操作系统和工作状态

1. 描述

   - 操作系统补丁

     当系统加载时，ACPI的_OSI会接收到一个参数，不同的系统，接收的参数不同，ACPI执行的指令不同。比如，系统是win7，这个参数是"Windows 2009"，系统是win8，这个参数就是"Windows 2012"。

     注：win10有多个版本，分别对应不同的参数。

     可能是为了方便使用，ACPI还定义了OSYS。OSYS和上述参数关系如下：

     OSYS = 0x07D9: win7系统，即"Windows 2009"。

     OSYS = 0x07DC: win8系统，即"Windows 2012"。

     OSYS = 0x07DD: win8.1系统，即"Windows 2013"。

     OSYS = 0x07DF: win10第一个版本，即"Windows 2015"。

     。。。

     注：OSYS是后期被赋值的，就是说我们可以随时修改它。

     当加载的系统不被ACPI识别时，OSYS被赋另一个值，这个值随机器不同而不同，有的是Linux代码，有的是Windows2003代码，有的是其他代码。

     不同的操作系统支持不同的硬件，比如win8以上才支持I2C总线。当加载MAC系统时，_OSI接受的参数不会被ACPi识别，OSYS被预先赋的值也毫无意义。这就需要补丁来纠正这种错误，操作系统补丁也源于此。

   - 工作状态设定

     多数ACPI会这样做：(1)读取_OSI，如"Windows 2009"；(2)向OSYS赋值，如0x07D9；(3)厂商内设参数并赋值，如win7=1。

     厂商内设参数没有规范化，TP采用win7，win8。dell采用win7，win8，wn81。

     - 较新的机器没有第三步。
     - 早期的机器可能没有第二步。

     厂商内设参数多用于硬件功能方面的管理。比如win7和win8对USB管理方式不同。再比如，dell机器的睡眠灯和FN功能键在win7和win8下显著不同。

     为了描述方便，我们将OSYS对硬件的管理定义为操作系统补丁；将厂商内设参数对硬件功能的管理定义为工作状态设定。

2. 补丁

   - SSDT-OCOS

     我们制作一个SSDT-OCOS补丁，补丁里虚拟一个PCI1设备，设备初始化时自动修正OSYS值。

     ```swift
         Device (PCI1)
         {
             Name (_ADR, Zero)
             Method (_INI, 0, NotSerialized)
             {
                 OSYS = 0x07DC 
             }
     ```

     声明：

     SSDT-OCOS并不是真正意义上操作系统补丁，它无法改变【If ( _OSI ("Windows 20xx"))】这样的语句走向。使用时应仔细甄别 DSDT中【If ( _OSI ("Windows 20xx"))】和【OSYS=xxxx】逻辑关系，设定的OSYS值不要出现逻辑相悖。

     示例分析：
     
     ```swift
         If ((_OSI ("Windows 2009") || _OSI ("Windows 2013")))
         {
              OperationRegion (PCF0, SystemMemory, 0xF0100000, 0x0200)
              Field (PCF0, ByteAcc, NoLock, Preserve)
              {
                  HVD0,   32, 
                  Offset (0x160), 
               TPR0,   8
              }
     ```
     
     这段代码意思是：系统是win7或者win8.1才执行这些内容，其他系统，包括MAC不执行这些内容。假如补丁里设置了OSYS=0x07D9(win7)，那么，和OSYS有关都会执行win7操作，而上述代码却不执行。这就是前文所说的逻辑相悖。我们的做法是：既然补丁无力改变这些，那么我们选择回避它。让OSYS=0x07DC(win8)，或者OSYS=0x07DF(win10)，保证ACPI逻辑上的正确性。


​     

   - SSDT-OCWork-* * *
   
     DSDT中搜索“ _OSI ”、“win7”、“OSID”，必要时搜索“OSYS”。搜索中发现和【If ( _OSI ("Windows 20xx"))】有关而与OSYS无关的就是厂商内设参数。dell5480如下：
   
     ```swift
         Name (WIN7, "Windows 2009")
         Name (WIN8, "Windows 2012")
         Name (WN81, "Windows 2013")
         Name (LINX, "Linux")
         Scope (_SB)
         {
             Name (ACOS, Zero)
             Name (ACSE, Zero)
             Method (OSID, 0, NotSerialized)
             {
                 If ((ACOS == Zero))
                 {
                     ACOS = One
                     ACSE = Zero
                     If (CondRefOf (\_OSI, Local0))
                     {
                         If (_OSI (WXP))
                         {
                             ACOS = 0x10
                         }
                     		If (_OSI (WLG))
                     		{
                         		ACOS = 0x20
                     		}
     
                     		If (_OSI (WIN7))
                     		{
                         		ACOS = 0x80
                     		}
     
                     		If (_OSI (WIN8))
                     		{
                         		ACOS = 0x80
                         		ACSE = One
                     		}
                     
                     		If (_OSI (WN81))
                     		{
                         		ACOS = 0x80
                         		ACSE = 0x02
                     		}
     ```

     以上WIN7，WIN8，WN81，ACOS，ACSE就是厂商内设参数。真正影响硬件功能的只有ACOS，ACSE。
     
     SSDT-OCWork-dell补丁如下：
     
     ```swift
              Scope (\)
              {
              		If (_OSI ("Darwin"))
              		{
                  		\_SB.ACOS = 0x80
                  		\_SB.ACSE = 0 //0:win7,,1:win8,,2:win81
              		}
              }
     ```

	SSDT-OCWork-* * *补丁本身不复杂，复杂的是每台机器都不同。

3. 简单操作方法

   - 对于操作系统补丁：设定OSYS为机器所能支持的最大值。
   - 对于工作状态设定：厂商内设参数的应用基本都是早期机器，多数情况下，设定OSYS为最大值后可以忽略工作状态设定。忽略后所产生的影响也是硬件功能方面的，不会对系统造成大的伤害。

4. 补丁拓展应用

   通过上述两个补丁的应用，我们总结得出修正某一变量的两种方法（不使用任何更名）：

   - 《覆盖变量法》——即前文的SSDT-OCOS方法。在变量所在的同一位置（树）仿冒一个device，初始化时修正这个变量。
   - 《预置变量法》——即前文的SSDT-OCWork方法。在ACPI的最前端直接修正这个变量。

   示例：假如要禁止某设备。通常禁止的方法是使设备的 _STA返回0。

   原文：

   ```swift
           Method (_STA, 0, NotSerialized)  // _STA: Status
           {
               ECTP (Zero)
               If ((SDS1 == 0x07))
               {
                   Return (0x0F)
               }
   
               Return (Zero)
           }
   ```

   可以看出，只要让SDS1不等于0x07就行。采用《预置变量法》如下：

   ```swift
       	Scope (\)
       	{
       		External (SDS1, FieldUnitObj)
       		If (_OSI ("Darwin"))
       		{
       			SDS1 = 0
       		}
       	}
  ```

5. 拓展性应用注意事项

   需要修正的变量如果是“FieldUnitObj”类型的，有可能不起作用，试验决定。